<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Entrega de SIMs F√≠sicas Kolbi</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data:;">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="stylesheet" href="../renderer/styles.css">
<link rel="stylesheet" href="../renderer/neon.css">
<link rel="icon" href="./kolbi.png" type="image/png">
</head>
<body>
<main class="shell">
    <header class="topbar" style="background:#43b02a; padding:0;">
    <div class="kolbi-header-row">
        <div style="display:flex;align-items:center;gap:12px;">
        <img src="./kolbi.png" alt="Kolbi" style="height:32px;margin-right:8px;">
        <div style="display:flex;flex-direction:column;align-items:flex-start;min-width:180px;">
            <span class="kolbi-title">Entrega de SIMs F√≠sicas Kolbi</span>
            <span class="kolbi-eslogan">#somos de los mismos</span>
        </div>
        </div>
        <nav class="tabs">
        <button class="tab active" data-target="#tab-form"><span class="tab-dot"></span> Formulario</button>
        <button class="tab" data-target="#tab-inventario"><span class="tab-dot"></span> Inventario</button>
        
        <button class="tab" data-target="#tab-entregas"><span class="tab-dot"></span> Entregas</button>
        <button class="tab" data-target="#tab-credits"><span class="tab-dot"></span> Cr√©ditos</button>
        </nav>
        <div class="row">
        <div id="neonClock" class="muted" aria-live="polite">--:--</div>
        <label for="miniDate" style="margin-right:6px;">Fecha:</label>
        <input id="miniDate" type="date" />
        </div>
    </div>
    </header>

<section id="tab-form" class="tabpanel active">
    <section class="card glass">
    <h2 class="card-title">Supervisor</h2>
    <div class="grid grid-3">
        <label class="full">Supervisor activo
        <div class="row">
            <input id="supCorreo" placeholder="correo@ice.go.cr" />
            <input id="supClave" type="password" placeholder="Clave" />
            <button id="btnLogin" type="button" class="btn btn-neon">Iniciar sesi√≥n</button>
            <button id="btnLogoff" type="button" class="btn btn-ghost">Salir</button>
        </div>
        <small id="supEstado" class="muted">No autenticado</small>
        </label>
    </div>
    <div id="guardNote" class="muted" style="margin-top:8px">
        * Solo el supervisor autenticado puede generar y enviar SIMs.
    </div>
    </section>

    <section class="card glass" data-guard="sims">
    <h2 class="card-title">Agente destino</h2>
    <div class="grid">
        <label class="full">Seleccionar agente (libreta)
        <select id="selAgente"></select>
        </label>
        <label>Agente
        <input id="agente" placeholder="Nombre del agente" />
        </label>
        <label>Usuario
        <input id="usuario" placeholder="Usuario/cliente (ej. rumadr)" />
        </label>
        <label class="full">Correo del agente
        <input id="correo" placeholder="correo@empresa.com" />
        </label>
    </div>
    <div class="subtle-title">Agregar / actualizar en libreta</div>
    <div class="grid grid-3">
        <input id="newNombre" placeholder="Nombre completo" />
        <input id="newUsuario" placeholder="Usuario (ej. emondragon)" />
        <input id="newCorreo"  placeholder="correo@ice.go.cr" />
    </div>
    <div class="row gap">
        <button id="btnAddAgente" class="btn btn-outline">Guardar agente</button>
        <button id="btnDelAgente" class="btn btn-outline btn-danger">Eliminar por correo</button>
    </div>
    </section>

    <section class="card glass" data-guard="sims">
    <h2 class="card-title">Detalle de SIMs</h2>
    <div class="grid">
        <label class="full">Contenido de la SIM (pegar aqu√≠)
        <textarea id="contenido" rows="10" placeholder="Pegue el texto completo de la SIM‚Ä¶"></textarea>
        </label>
    </div>
    <div class="subtle-title">Firma del supervisor</div>
    <div class="sign-box">
        <img id="imgFirmaFija" src="./firmasupervisor.jpg" alt="Firma supervisor" style="max-width:300px;max-height:120px;">
        <small class="muted">Firma del supervisor</small>
    </div>
    <div class="row gap actions">
        <button id="btnGenerar" class="btn btn-neon big">Generar PDF y Enviar</button>
    </div>
    </section>

    <section class="card paper" data-guard="sims">
    <h2 class="card-title">Vista previa (PDF)</h2>
    <div id="preview" class="preview">
        <div class="preview-head">
        <div><strong>Agente:</strong> <span id="pvAgente">‚Äî</span></div>
        <div><strong>Usuario:</strong> <span id="pvUsuario">‚Äî</span></div>
        <div><strong>Correo:</strong> <span id="pvCorreo">‚Äî</span></div>
        <div><strong>Fecha:</strong> <span id="pvFecha">‚Äî</span></div>
        </div>
        <hr>
        <pre id="pvContenido"></pre>
        <div class="preview-sign">
        <img id="imgFirmaFijaPreview" src="./firmasupervisor.jpg" alt="firma del supervisor" style="max-width:300px;max-height:120px;" />
        <div class="sign-line">______________________________</div>
        <div class="sign-label">Firma del supervisor</div>
        </div>
    </div>
    </section>
</section>

<section id="tab-inventario" class="tabpanel">
    <section class="card glass">
    <h2 class="card-title">Inventario de Terminales</h2>
    <div style="margin-bottom:10px">
        <label class="full">Cargar terminales (pegar aqu√≠, formato: Agencia,Marca,Terminal,Disponible)
        <textarea id="terminalesPaste" rows="6" placeholder="Pega aqu√≠ la lista de terminales..."></textarea>
        </label>
        <button id="btnCargarTerminales" class="btn btn-outline" style="margin-top:6px">Cargar terminales</button>
    </div>
    <div class="row gap" style="flex-wrap:wrap">
        <div class="muted">Actualizado: <span id="invFechaTag">‚Äî</span></div>
        <button id="btnInvRefrescar" class="btn btn-outline">Refrescar</button>
        <input id="invBuscar" placeholder="Buscar modelo‚Ä¶" style="max-width:260px" />
    </div>
    <div class="subtle-title">Filtrar por marca</div>
    <div class="row gap" style="flex-wrap:wrap">
        <button class="btn btn-ghost active" data-brand="all">Todas</button>
        <button class="btn btn-ghost" data-brand="Samsung">Samsung</button>
        <button class="btn btn-ghost" data-brand="Apple">Apple</button>
        <button class="btn btn-ghost" data-brand="Xiaomi">Xiaomi</button>
        <button class="btn btn-ghost" data-brand="Huawei">Huawei</button>
        <button class="btn btn-ghost" data-brand="Motorola">Motorola</button>
        <button class="btn btn-ghost" data-brand="Honor">Honor</button>
        <button class="btn btn-ghost" data-brand="Oppo">Oppo</button>
    </div>
    </section>
    <section class="card paper">
    <div class="grid full">
        <table id="tablaInventario" style="width:100%; border-collapse:collapse">
        <thead>
            <tr>
            <th style="text-align:left; padding:8px 6px;">Agencia</th>
            <th style="text-align:left; padding:8px 6px;">Marca</th>
            <th style="text-align:left; padding:8px 6px;">Terminal</th>
            <th style="text-align:right; padding:8px 6px;">Disponible</th>
            </tr>
        </thead>
        <tbody></tbody>
        </table>
    </div>
    <small class="muted">La lista se edita manualmente o pegando la lista en la interfaz.</small>
    </section>
</section>



<section id="tab-entregas" class="tabpanel">
    <section class="card glass">
        <h2 class="card-title">Historial de entregas</h2>
        <div id="graficoEntregas"></div>
        <div id="entregasList"></div>
        <label>Filtrar por correo:
            <input id="filtroCorreo" placeholder="Correo del agente" />
        </label>
            <button id="resetHistorialBtn" style="margin-top:16px;background:#c00;color:#fff;padding:8px 18px;border:none;border-radius:6px;cursor:pointer;">
                üóëÔ∏è Resetear historial de entregas
            </button>
            <button id="btnHistorialPdf" class="btn btn-outline">Generar PDF de historial</button>
    </section>
</section>

<section id="tab-credits" class="tabpanel">
    <section class="card glass credits">
    <div class="credits-glow"></div>
    <h2 class="card-title">Cr√©ditos</h2>
    <div class="credits-body">
        <div class="credits-title">Ruben Madrigal Jimenez</div>
        <div class="credits-sub">Full Stack Developer ‚Äî Infinix DEVcom</div>
        <p class="muted">
        Aplicaci√≥n de escritorio para formateo de SIMs, firma de supervisor, generaci√≥n de PDF
        y env√≠o por correo corporativo con Microsoft Graph (OAuth2).
        </p>
    </div>
    </section>
</section>
</main>

<script>
// Tabs
const tabs = document.querySelectorAll('.tab');
const panels = document.querySelectorAll('.tabpanel');
tabs.forEach(btn => {
    btn.addEventListener('click', () => {
    tabs.forEach(b => b.classList.remove('active'));
    panels.forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    const target = document.querySelector(btn.dataset.target);
    if (target) target.classList.add('active');
    });
});

// Reloj/fecha
const neonClock = document.getElementById('neonClock');
const miniDate  = document.getElementById('miniDate');
function pad(n){ return String(n).padStart(2,'0'); }
function tick() {
    const d = new Date();
    neonClock.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    if (!miniDate.value) miniDate.valueAsDate = d;
}
tick(); setInterval(tick, 1000);

// Guard SIMs
function setSimsGuard(isLogged) {
    document.querySelectorAll('[data-guard="sims"]').forEach(el => {
    el.style.pointerEvents = isLogged ? 'auto' : 'none';
    el.style.opacity = isLogged ? '1' : '0.45';
    });
    const note = document.getElementById('guardNote');
    if (note) note.style.display = isLogged ? 'none' : 'block';
}
setSimsGuard(false);

// Login/logout
let supervisorAutenticado = false;
document.getElementById('btnLogin').onclick = async function() {
    const correo = document.getElementById('supCorreo').value.trim();
    const clave  = document.getElementById('supClave').value.trim();
    if (!correo || !clave) return alert('Ingrese el correo y la clave');
    const result = await window.electronAPI.authSupervisor({ email: correo, password: clave });
    if (result.ok) {
    supervisorAutenticado = true;
    setSimsGuard(true);
    document.getElementById('supEstado').textContent = 'Autenticado como ' + correo;
    habilitarTerminales(true);
    } else {
    supervisorAutenticado = false;
    setSimsGuard(false);
    habilitarTerminales(false);
    alert('Correo o clave incorrectos');
    }
};
document.getElementById('btnLogoff').onclick = function() {
    supervisorAutenticado = false;
    setSimsGuard(false);
    habilitarTerminales(false);
    document.getElementById('supEstado').textContent = 'No autenticado';
    document.getElementById('supCorreo').value = '';
    document.getElementById('supClave').value = '';
};

// Habilitar/deshabilitar controles de terminales
function habilitarTerminales(estado) {
    ['btnCargarTerminales','terminalesPaste']
    .forEach(id => { const el = document.getElementById(id); if (el) el.disabled = !estado; });
}
document.addEventListener('DOMContentLoaded', () => {
    habilitarTerminales(false);
    cargarAgentes();
    cargarNotas();
    cargarEntregas();
});

// ===== AGENTES =====
async function cargarAgentes() {
    const agentes = await window.electronAPI.listAgents();
    const sel = document.getElementById('selAgente');
    sel.innerHTML = '<option value="">‚Äî Seleccione ‚Äî</option>';
    agentes.forEach(a => {
    const opt = document.createElement('option');
    opt.value = a.correo;
    opt.textContent = `${a.nombre || ''} (${a.correo})`;
    sel.appendChild(opt);
    });
}
document.getElementById('selAgente').onchange = function() {
    const correo = this.value;
    window.electronAPI.listAgents().then(agentes => {
    const ag = agentes.find(a => a.correo === correo);
    document.getElementById('agente').value = ag?.nombre || '';
    document.getElementById('usuario').value = ag?.usuario || '';
    document.getElementById('correo').value  = ag?.correo || '';
    });
};
document.getElementById('btnAddAgente').onclick = async function() {
    const nombre = document.getElementById('newNombre').value.trim();
    const usuario = document.getElementById('newUsuario').value.trim();
    const correo  = document.getElementById('newCorreo').value.trim();
    if (!nombre || !usuario || !correo) return alert('Completa todos los campos');
    const result = await window.electronAPI.addAgent({ nombre, usuario, correo });
    if (result.ok) {
    await cargarAgentes();
    alert('Agente guardado');
    document.getElementById('newNombre').value = '';
    document.getElementById('newUsuario').value = '';
    document.getElementById('newCorreo').value  = '';
    }
};
document.getElementById('btnDelAgente').onclick = async function() {
    const correo = document.getElementById('newCorreo').value.trim();
    if (!correo) return alert('Indica el correo para eliminar');
    const result = await window.electronAPI.removeAgent(correo);
    if (result.ok) { await cargarAgentes(); alert('Agente eliminado'); }
};

// ===== Firma fija + preview =====
function actualizarPreviewSIM() {
    document.getElementById('pvAgente').textContent   = document.getElementById('agente').value;
    document.getElementById('pvUsuario').textContent  = document.getElementById('usuario').value;
    document.getElementById('pvCorreo').textContent   = document.getElementById('correo').value;
    document.getElementById('pvFecha').textContent    = miniDate.value;
    document.getElementById('pvContenido').textContent= document.getElementById('contenido').value;
}
['agente','usuario','correo','contenido'].forEach(id => {
    const el = document.getElementById(id);
    el.oninput = actualizarPreviewSIM;
});
miniDate.oninput = actualizarPreviewSIM;

// ===== Generar PDF y (futuro) enviar =====
document.getElementById('btnGenerar').onclick = async function() {
    if (!supervisorAutenticado) return alert('Debe autenticarse como supervisor.');
    actualizarPreviewSIM();

    const payload = {
    agente:   document.getElementById('agente').value.trim(),
    usuario:  document.getElementById('usuario').value.trim(),
    correo:   document.getElementById('correo').value.trim(),
    fecha:    document.getElementById('miniDate').value,
    contenido:document.getElementById('contenido').value,
    firmaPath: "./firmasupervisor.jpg"
    };

    const res = await window.electronAPI.generateAndSendSIM(payload);
    if (res?.ok) alert(`PDF generado en:\n${res.path}${res.sent ? '\nCorreo enviado.' : ''}`);
    else alert(`Error al generar/enviar: ${res?.error || 'desconocido'}`);
};

// ===== Inventario (carga/render b√°sicos) =====
let terminalesData = [];
async function cargarTerminales() {
    const result = await window.electronAPI.listTerminales();
    terminalesData = Array.isArray(result) ? result : [];
    renderInventarioTerminales();
    actualizarFechaInventario();
}

function renderInventarioTerminales(filterBrand = 'all', search = '') {
    const tbody = document.querySelector('#tablaInventario tbody');
    tbody.innerHTML = '';
    const terminos = terminalesData.filter(t => {
        const brandOk = filterBrand === 'all' || (t.marca && t.marca.toLowerCase() === filterBrand.toLowerCase());
        const textOk  = !search || (t.terminal || '').toLowerCase().includes(search.toLowerCase());
        return brandOk && textOk;
    });
    for (const t of terminos) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="padding:6px;">${t.agencia || ''}</td>
            <td style="padding:6px;">${t.marca || ''}</td>
            <td style="padding:6px;">${t.terminal || ''}</td>
            <td style="padding:6px; text-align:right;">${Number(t.disponible)||0}</td>`;
        tbody.appendChild(tr);
    }
}
function actualizarFechaInventario() {
    const el = document.getElementById('invFechaTag');
    if (el) el.textContent = new Date().toLocaleString();
}

document.getElementById('btnCargarTerminales').onclick = async () => {
    const txt = document.getElementById('terminalesPaste').value.trim();
    if (!txt) return;
    const rows = txt.split(/\r?\n/).map(line => line.split('\t').map(v => v.trim()));
    const bulk = rows
        .filter(r => r.length >= 4)
        .map(([agencia, marca, terminal, disponible]) => ({
            agencia, marca, terminal, disponible: Number(disponible) || 0
        }));
    const res = await window.electronAPI.bulkAddTerminales(bulk);
    if (res?.ok) { await cargarTerminales(); alert(`Cargados ${res.count} registros`); }
};

document.getElementById('btnInvRefrescar').onclick = cargarTerminales;
document.getElementById('invBuscar').oninput = (e) => {
    const brandBtn = document.querySelector('.btn.btn-ghost.active');
    const brand = brandBtn?.dataset?.brand || 'all';
    renderInventarioTerminales(brand, e.target.value || '');
};
document.querySelectorAll('[data-brand]').forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll('[data-brand]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderInventarioTerminales(btn.dataset.brand, document.getElementById('invBuscar').value || '');
    };
});
cargarTerminales();

// ===== Notas del supervisor =====
async function cargarNotas() {
    const notasList = document.getElementById('notasList');
    const notas = await window.electronAPI.listNotas();
    notasList.innerHTML = '';
    notas.forEach(nota => {
        const div = document.createElement('div');
        div.className = 'nota-item';
        div.innerHTML = `
            <div>
                <b>${nota.autor}</b> <span class="muted">${nota.fecha} ${nota.hora}</span>
            </div>
            <div>${nota.texto}</div>
            <button class="btn btn-outline" onclick="editarNota('${nota.id}')">Editar</button>
            <button class="btn btn-danger" onclick="borrarNota('${nota.id}')">Borrar</button>
            <hr>
        `;
        notasList.appendChild(div);
    });
}
document.getElementById('btnAgregarNota').onclick = async function() {
    const texto = document.getElementById('notaNueva').value.trim();
    if (!texto) return alert('Escribe una nota');
    const fecha = new Date().toISOString().slice(0,10);
    const hora = new Date().toLocaleTimeString('es-CR', { hour: '2-digit', minute: '2-digit' });
    const autor = document.getElementById('supCorreo').value || 'Supervisor';
    await window.electronAPI.addNota({ texto, fecha, hora, autor });
    document.getElementById('notaNueva').value = '';
    cargarNotas();
};
window.editarNota = async function(id) {
    const notas = await window.electronAPI.listNotas();
    const nota = notas.find(n => n.id === id);
    if (!nota) return;
    const nuevoTexto = prompt('Editar nota:', nota.texto);
    if (nuevoTexto !== null) {
        await window.electronAPI.editNota({ ...nota, texto: nuevoTexto });
        cargarNotas();
    }
};
window.borrarNota = async function(id) {
    if (confirm('¬øEliminar esta nota?')) {
        await window.electronAPI.removeNota(id);
        cargarNotas();
    }
};

// ===== Historial de entregas y gr√°fico =====
async function cargarEntregas() {
    const entregasList = document.getElementById('entregasList');
    const graficoDiv = document.getElementById('graficoEntregas');
    const filtroCorreo = document.getElementById('filtroCorreo').value.trim();
    const entregas = await window.electronAPI.listHistorial(filtroCorreo || null);

    // Listado
    entregasList.innerHTML = '';
    entregas.forEach(e => {
        const div = document.createElement('div');
        div.className = 'entrega-item';
        div.innerHTML = `
            <div><b>${e.agente}</b> <span class="muted">${e.fecha} ${e.hora}</span></div>
            <div><b>Usuario:</b> ${e.usuario} <b>Correo:</b> ${e.correo}</div>
            <pre>${e.contenido}</pre>
            <a href="${e.pdf}" target="_blank">Abrir PDF</a>
            <hr>
        `;
        entregasList.appendChild(div);
    });

    // Gr√°fico simple: entregas por agente
    const conteo = {};
    entregas.forEach(e => {
        conteo[e.agente] = (conteo[e.agente] || 0) + 1;
    });
    graficoDiv.innerHTML = '<h4>Entregas por agente</h4>';
    Object.entries(conteo).forEach(([agente, total]) => {
        const bar = document.createElement('div');
        bar.style.background = '#0c59cc';
        bar.style.color = '#fff';
        bar.style.margin = '4px 0';
        bar.style.padding = '4px 8px';
        bar.style.width = `${40 + total * 40}px`;
        bar.textContent = `${agente}: ${total}`;
        graficoDiv.appendChild(bar);
    });
}
document.getElementById('filtroCorreo').oninput = cargarEntregas;
document.getElementById('btnHistorialPdf').onclick = async function() {
    const correo = document.getElementById('filtroCorreo').value.trim();
    if (!correo) return alert('Indica el correo para el PDF');
    const res = await window.electronAPI.historialPdf(correo);
    if (res?.ok) alert(`PDF generado en:\n${res.path}`);
    else alert(`Error al generar PDF: ${res?.error || 'desconocido'}`);
};
</script>
</body>
</html>